<div class="mainContainer">
  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  />
  <app-header></app-header>

  <div class="container">
    <!-- LEFT PANEL -->
    <div class="left-panel">
      <ul>
        <!-- Queries Section -->
        <li class="section-header">
          <h4 class="queriestitle">Queries</h4>
          <button id="addQueryBtn" (click)="addQueries()">+</button>
        </li>

        <!-- Render each query as a button -->
        <div id="queryContainer">
          <div *ngFor="let query of queries" class="queryItem">
            <button
              class="query-button"
              (click)="openQuery(query)"
              [ngClass]="{ 'selected-query': selectedQuery === query }"
            >
              {{ query.name }}
            </button>
          </div>
        </div>
      </ul>

      <hr />

      <!-- Charts Section -->
      <ul>
        <li class="section-header">
          <h4 class="charttitle">Charts</h4>
          <button id="addchartBtn" (click)="addCharts()">+</button>
        </li>
        <div id="chartsContainer"></div>
      </ul>

      <hr />

      <!-- Dashboard Section -->
      <ul>
        <li class="section-header">
          <h4 class="dashboardtitle">Dashboard</h4>
          <button id="adddashboardBtn" (click)="addDashboard()">+</button>
        </li>
        <div id="dashboardContainer"></div>
      </ul>
    </div>

    <!-- CENTER PANEL (60% width) -->
    <div class="center">
      <!-- If no query is opened, show a message -->
      <ng-container *ngIf="selectedQuery; else noQueryOpen">
        <!-- If this query has no table chosen, show "NO QUERY AVAILABLE" -->
        <ng-container *ngIf="!selectedQuery.selectedTable; else showTable">
          <h1>NO QUERY AVAILABLE</h1>
        </ng-container>

        <!-- If the query does have a selected table, show the table data -->
        <ng-template #showTable>
          <table border="2">
            <thead>
              <tr>
                <th *ngFor="let col of selectedQuery.columns">{{ col }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of selectedQuery.tableData">
                <td *ngFor="let col of selectedQuery.columns">
                  {{ row[col] }}
                </td>
              </tr>
            </tbody>
          </table>
        </ng-template>
      </ng-container>
      <ng-template #noQueryOpen>
        <h1>Please open a query</h1>
      </ng-template>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-pannel">
      <div class="detail-box">
        <h4 class="Rdetails">Details</h4>
        <label for="queryTitle" class="Rqueriestitle">Query Title</label>
        <!-- Only editable if a query is opened -->
        <input
          id="queryTitle"
          type="text"
          class="queriestext"
          [(ngModel)]="queryTitle"
          (keyup.enter)="updateSelectedQueryName()"
          [disabled]="!selectedQuery"
        />
      </div>
      <hr />

      <div>
        <h4 class="Roperations">Operations</h4>
      </div>

      <div class="operations-container">
        <!-- Enable Add Operations only if a query is open -->
        <button
          class="addOperations"
          (click)="toggleOverlay($event)"
          [disabled]="!selectedQuery"
        >
          + Add Operations
        </button>

        <!-- Small overlay with operation options -->
        <div class="overlay" *ngIf="showOverlay" #overlay>
          <ul>
            <li (click)="openTableOverlay()">
              <i class="fa-solid fa-database"></i>Select Source
            </li>
            <li (click)="openColumnOverlay()">
              <i class="fa-solid fa-table-columns"></i>Choose Columns
            </li>
            <li><i class="fa-solid fa-filter"></i>Filter Rows</li>
            <li (click)="openJoinTableOverlay()">
              <i class="fa-solid fa-circle-half-stroke"></i>Join Table
            </li>
            <li (click)="openAppendTableOverlay()">
              <i class="fa-solid fa-layer-group"></i>Append Table
            </li>
            <li (click)="openAddColumnOverlay()">
              <i class="fa-solid fa-florin-sign"></i>Add New Column
            </li>
            <li><i class="fa-solid fa-object-group"></i>Group and Summarize</li>
            <li (click)="openCustomOperationOverlay()">
              <i class="fa-sharp fa-solid fa-worm"></i>Custom Operation
            </li>
          </ul>
        </div>

        <!-- Select Source Overlay -->
        <div class="table-overlay" *ngIf="showTableOverlay">
          <div class="table-overlay-content">
            <h4>Select a Table</h4>
            <ul>
              <li
                *ngFor="let table of tables"
                (click)="selectSourceTable(table)"
              >
                {{ table }}
              </li>
            </ul>
            <button (click)="closeTableOverlay()" class="button">Close</button>
          </div>
        </div>

        <!-- Choose Columns Overlay -->
        <div class="column-overlay" *ngIf="showColumnOverlay">
          <div class="column-overlay-content">
            <h4>Select Columns</h4>
            <!-- columns for the currently opened query -->
            <ul>
              <li *ngFor="let column of selectedQuery?.columns">
                <input
                  type="checkbox"
                  [value]="column"
                  (change)="toggleColumnSelection(column, $event)"
                />
                {{ column }}
              </li>
            </ul>
            <button (click)="confirmColumnSelection()">Confirm</button>
            <button (click)="closeColumnOverlay()">Close</button>
          </div>
        </div>

        <!-- Add New Column Overlay -->
        <div class="add-column-overlay" *ngIf="showAddColumnOverlay">
          <div class="add-column-content">
            <h3>Add New Column</h3>
            <label>Expression:</label>
            <textarea [(ngModel)]="newColumnExpression" rows="3"></textarea>

            <label>Column Name:</label>
            <input
              type="text"
              [(ngModel)]="newColumnName"
              placeholder="Enter column name"
            />

            <label>Column Type:</label>
            <select [(ngModel)]="newColumnType">
              <option *ngFor="let type of columnTypes" [value]="type">
                {{ type }}
              </option>
            </select>

            <div class="buttons">
              <button (click)="confirmAddColumn()">Confirm</button>
              <button (click)="closeAddColumnOverlay()">Close</button>
            </div>
          </div>
        </div>

        <!-- Join Table Overlay -->
        <div class="join-table-overlay" *ngIf="showJoinTableOverlay">
          <div class="join-table-content">
            <h3>Join Table</h3>

            <label>Select Table:</label>
            <select
              [(ngModel)]="selectedJoinTable"
              (ngModelChange)="RightTable($event)"
            >
              <option *ngFor="let table of tables" [value]="table">
                {{ table }}
              </option>
            </select>

            <div class="column-selection">
              <label>Join On:</label>
              <div class="join-condition">
                <!-- Left columns from the open query -->
                <select [(ngModel)]="selectedLeftColumn">
                  <option
                    *ngFor="let col of selectedQuery?.columns"
                    [value]="col"
                  >
                    {{ col }}
                  </option>
                </select>
                <span>=</span>
                <select [(ngModel)]="selectedRightColumn">
                  <option *ngFor="let col of rightcolumns" [value]="col">
                    {{ col }}
                  </option>
                </select>
              </div>
            </div>

            <label>Join Type:</label>
            <select [(ngModel)]="selectedJoinType">
              <option *ngFor="let join of joinTypes" [value]="join">
                {{ join }}
              </option>
            </select>

            <label>Columns to Include:</label>
            <select [(ngModel)]="selectedJoinColumns">
              <option *ngFor="let col of selectedQuery?.columns" [value]="col">
                {{ col }}
              </option>
            </select>

            <div class="buttons">
              <button (click)="confirmJoinTable()">Confirm</button>
              <button (click)="closeJoinTableOverlay()">Close</button>
            </div>
          </div>
        </div>

        <!-- Append Table Overlay -->
        <div class="append-table-overlay" *ngIf="showAppendTableOverlay">
          <div class="append-table-overlay-content">
            <h4>Append Table</h4>
            <label>Select Table to Append:</label>
            <select [(ngModel)]="selectedTableToAppend">
              <option *ngFor="let table of tables" [value]="table">
                {{ table }}
              </option>
            </select>

            <label>Drop Duplicates?</label>
            <select [(ngModel)]="dropDuplicates">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>

            <div class="append-table-actions">
              <button (click)="confirmAppendTable()">Confirm</button>
              <button (click)="closeAppendTableOverlay()">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Custom Operation Overlay -->
        <div class="custom-oper-overlay" *ngIf="showCustomOperationOverlay">
          <div class="custom-oper-overlay-content">
            <h4>Custom Operation</h4>
            <label for="customExpression">Enter Custom Expression:</label>
            <textarea
              id="customExpression"
              [(ngModel)]="customExpression"
              rows="6"
              placeholder="Write your custom operation here..."
            ></textarea>

            <div class="custom-oper-actions">
              <button (click)="confirmCustomOperation()">Confirm</button>
              <button (click)="closeCustomOperationOverlay()">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
